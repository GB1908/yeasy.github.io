<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">
<head>
<title> gnuplot / webplot / access_cgi </title>
<!-- Generated 2000/ 2/17 -->
<!-- $Id: access_cgi.html,v 1.8 2004/12/04 10:02:08 kawano Exp $ -->
<meta http-equiv="content-type" content="text/html;charset=iso-2022-jp">
<link rel="stylesheet" href="../style-new.css" type="text/css">
</head>

<body>

<table width="100%" border="0" cellpadding="0" cellspacing="0">
<tr><td bgcolor="#cccc90" width="320">
    <div align="left">
    <a href="../index.html">
    <img src="../image/gnuplot_logo2.png" alt="GNUPLOT" width="320" height="90">
    </a></div></td>
    <td bgcolor="#cccc90">
      <div align="center"><h3> - not so Frequently Asked Questions - </h3> </div>
      <div class="update"> update 2004/11/29 </div>
    </td>
</tr>
<tr><td bgcolor="#fae8ba"></td>
    <td bgcolor="#fae8ba"><div class="navi"> 
<a href="../index.html">          HOME </a> |
<a href="../intro/index.html">    INTRODUCTION </a> |
<a href="../general.html">        INFORMATION </a> |
<a href="../gallery/index.html">  GALLERY </a> |
<a href="access_cgi.html">        ENGLISH </a>
</div></td></tr>
</table>
<hr class="topsep">


<table width="100%" border="0" cellpadding="0" cellspacing="0">
<tr><td id="menu">
 <p> <a href="index.html">   WWW Access Log  </a></p>

 <ul>
  <li><a href="access_log.html"> access_logの解析・集計 </a>
  <li> 集計結果のプロット
   <ul>
    <li><a href="access_plot.html">定期的に集計 </a> 
    <li><a href="access_cgi.html"> CGIて集計 </a>
   </ul>
 </ul>
</td>

<td id="content">

<h1><a name="top"> 集計結果のプロット </a></h1>

<h2> CGIを使って毎回集計する方法 </h2>

<p> <a href="access_plot.html">前の方法</a>では，リアルタイムな集計は
できません．ここでは，CGIからperlのスクリプトを起動してaccess_logの集
計をする方法を紹介します．<a href="access_plot.html">前節</a>で作った
webplot.plに，htmlを出力する機能を追加しましょう．</p>

<p>まず，前節と同様に最初に画像の場所のPATHを定義します．サーバ内での絶
     対PATHと，httpdがアクセスする領域でのPATHが異なるので，これらを分け
     ておきます．</p>

<pre class="file">
$abspath='/absolute/path/to/parent_of_image/';
$webpath='/relative/path/to/parent_of_image/';
$imgfile="access.png";
$logfile='/home/www/httpd/logs/access_log';
$gnuplot='/path/to/gnuplot';
</pre>

<p> <tt>$abspath</tt>は，イメージファイルを置くディレクトリで，サーバ
上での絶対PATHで表します．<tt>$webpath</tt>はhttpdのルートから見たPATH
で，URLの一部になります．このCGIが呼ばれた時点でのイメージファイルを作
成しますので，このイメージファイル及びこのファイルを置くディレクトリ
は，httpdに書き込みの許可を与えておく必要があります．</p>

<p>全体の流れは，前節のスクリプトと同じです．</p>

<pre class="file">
open(LOG,$logfile);
while(&lt;LOG&gt;){
    if(/\.html/){
      split;
      $day = substr($_[3],1,2);
      $mon = substr($_[3],4,3);
      $year= substr($_[3],8,4);
      $count[$day]++;
    }
}
close(LOG);

$day=$#count;
$count[$day+1]=$count[$day];

&amp; make_gnuplot;
open(GNUPLOT,"| ".$gnuplot);
foreach $i (0..$#plot){ print GNUPLOT $plot[$i]; }
for($i=1;$i&lt;=$#count;$i++){
    printf(GNUPLOT "%10d%10d\n",$i,$count[$i]);
}
print GNUPLOT "end\n";
close(GNUPLOT);

&amp; generate_html;
exit 0;

sub make_gnuplot{
  $i=0;
  $plot[$i++]=sprintf("set term png color\n");
  $plot[$i++]=sprintf("set output '%s'\n",$abspath.$imgfile);
  $plot[$i++]=sprintf("set size 0.7,0.7\n");
  $plot[$i++]=sprintf("set xrange [0:32]\n");
  $plot[$i++]=sprintf("set yrange [0:*]\n");
  $plot[$i++]=sprintf("set xtics 1,7,31\n");
  $plot[$i++]=sprintf("set mxtics 7\n");
  $plot[$i++]=sprintf("set nokey\n");
  $plot[$i++]=sprintf("set grid\n");
  $plot[$i++]=sprintf("set title '%s %s'\n",$mon,$year);
  $plot[$i++]=sprintf("plot '-' with step\n");
}
</pre>


<p> gnuplotでイメージを作った後，そのURLをHTMLにしてブラウザに返す部分
が新たに追加されます．ここをsubroutine generate_htmlとしています．</p>

<pre class="file">

sub generate_html{
print &lt;&lt; "EOF";
Content-Type: text/html


&lt;html&gt;
&lt;head&gt;&lt;title&gt; access_log stat &lt;/title&gt;&lt;/head&gt;
&lt;body bgcolor="white"&gt;
&lt;center&gt;&lt;img src=\"$webpath$imgfile\"&gt;&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
EOF
</pre>

<p>できあがったperlのスクリプトをcgi-binの中に置いておき，htmlドキュメ
ントの中に次の様なリンクを作れば完成です．</p>

<div align="center"> &lt; a href="/cgi-bin/webplot_cgi.pl/"&gt; Web Plot &lt;/a&gt; </div>


<p> 一般に，イメージファイルはブラウザにキャッシュされるため，何度も続
けてブラウザからリクエストがあっても，イメージファイルの名前(上の例な
らaccess.png)が同じなら，このイメージの中身が更新されてもブラウザはキャッ
シュの内容を表示してしまい，毎回同じグラフが表示されます．これを避ける
簡単な方法は，毎回異なる名前でイメージを作成することです．perlはPIDを
変数$$に保持していますので，例えばこれを使って "access$$.png" とすれば
毎回異なるグラフを表示するようになります．但し，この方法だと次第にゴミ
ファイルが溜って行く欠点がありますが．(ブラウザにキャッシュさせないように
するheaderを送る方法もありますが，ここでは解説しません)</p>

<div class="top"><a href="access_cgi.html#top"><img src="../image/mark-up.png" alt="up"></a></div>

</td></tr></table>
<hr class="topsep">

</body>
</html>
