<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">
<head>
<title> gnuplot / webplot / access_plot </title>
<!-- Generated 2000/ 2/17 -->
<!-- $Id: access_plot.html,v 1.10 2004/12/04 10:02:08 kawano Exp $ -->
<meta http-equiv="content-type" content="text/html;charset=iso-2022-jp">
<link rel="stylesheet" href="../style-new.css" type="text/css">
</head>

<body>

<table width="100%" border="0" cellpadding="0" cellspacing="0">
<tr><td bgcolor="#cccc90" width="320">
    <div align="left">
    <a href="../index.html">
    <img src="../image/gnuplot_logo2.png" alt="GNUPLOT" width="320" height="90">
    </a></div></td>
    <td bgcolor="#cccc90">
      <div align="center"><h3> - not so Frequently Asked Questions - </h3> </div>
      <div class="update"> update 2004/11/29 </div>
    </td>
</tr>
<tr><td bgcolor="#fae8ba"></td>
    <td bgcolor="#fae8ba"><div class="navi"> 
<a href="../index.html">          HOME </a> |
<a href="../intro/index.html">    INTRODUCTION </a> |
<a href="../general.html">        INFORMATION </a> |
<a href="../gallery/index.html">  GALLERY </a> |
<a href="access_plot-e.html">     ENGLISH </a>
</div></td></tr>
</table>
<hr class="topsep">


<table width="100%" border="0" cellpadding="0" cellspacing="0">
<tr><td id="menu">
 <p> <a href="index.html">   WWW Access Log  </a></p>

 <ul>
  <li><a href="access_log.html"> access_logの解析・集計 </a>
  <li> 集計結果のプロット
   <ul>
    <li><a href="access_plot.html">定期的に集計 </a> 
    <li><a href="access_cgi.html"> CGIて集計 </a>
   </ul>
 </ul>
</td>

<td id="content">

<h1><a name="top"> 集計結果のプロット </a></h1>

<h2> 定期的に集計結果をプロットしておく方法 </h2>

<p> 集計結果を自動的にプロットしてGIFやPNGに出力するperlのスクリプトを
作ります．これを使って，定期的(週に1度や月に一度)集計結果をプロットし
たイメージを更新します．htmlに図を取り込むには，普通の&lt;img src=&gt;
のタグを使います．<a href="access_log.html">前節</a>で作ったwebplot.pl
をもう少し拡張しましょう．</p>


<pre class="file">
$logfile='/path/to/access_log';
$gnuplot='/path/to/gnuplot';
$imgfile='/path/to/access.png';
</pre>

<p> 最初にlogファイル，出力するイメージファイル，それからgnuplotのPATH 
を定義しておきます．gnuplotのインストール場所などは環境毎に異なるでしょ
うから，適当に自分の環境に合わせて絶対PATHで指定します．出力画像のファ
イル名<tt>$imgfile</tt>は何でも構いませんが，上の例ではとりあえずPNGの
拡張子を付けています．</p>

<pre class="file">
open(LOG,$logfile);
while(&lt;LOG&gt;){
    if(/\.html/){
      split;
      $day = substr($_[3],1,2);
      $mon = substr($_[3],4,3);
      $year= substr($_[3],8,4);
      $count[$day]++;
    }
}
close(LOG);

$day=$#count;
$count[$day+1]=$count[$day];
</pre>

<p>この部分は，前節とほぼ同じですが，標準入力から読み込むのではなく，log
     ファイルの名前を与えてファイルをopenしています．勿論，標準入力を使
     うことも可能です．また，年と月をグラフの表題として描くために，変数
     <tt>$mon, $year</tt>を追加しています(logファイルが毎月更新されてい
     る事を暗に期待しています)．</p>

<p> 最後の2行は，右端(31日目)のデータがヒストグラムできちんと描かれるよ
     うに，一日前と同じ数字を追加したものです．</p>


<pre class="file">
&amp; make_gnuplot;
open(GNUPLOT,"| ".$gnuplot);
foreach $i (0..$#plot){ print GNUPLOT $plot[$i]; }
for($i=1;$i&lt;=$#count;$i++){
    printf(GNUPLOT "%10d%10d\n",$i,$count[$i]);
}
print GNUPLOT "end\n";
close(GNUPLOT);
exit 0;
</pre>

<p> 集計結果をgnuplotに与えてプロットする部分です．gnuplotに与える種々の
     コマンドは，配列<tt>$plot</tt>に入っており，これは次のsubroutineで
     与えられています．</p>

<pre class="file">
sub make_gnuplot{
  $i=0;
  $plot[$i++]=sprintf("set term png color\n");
  $plot[$i++]=sprintf("set output '%s'\n",$imgfile);
  $plot[$i++]=sprintf("set size 0.7,0.7\n");
  $plot[$i++]=sprintf("set xrange [0:32]\n");
  $plot[$i++]=sprintf("set yrange [0:*]\n");
  $plot[$i++]=sprintf("set xtics 1,7,31\n");
  $plot[$i++]=sprintf("set mxtics 7\n");
  $plot[$i++]=sprintf("set nokey\n");
  $plot[$i++]=sprintf("set grid\n");
  $plot[$i++]=sprintf("set title '%s %s'\n",$mon,$year);
  $plot[$i++]=sprintf("plot '-' with step\n");
}
</pre>

<p> ここでは出力はPNGになっています．以下，<tt> set size </tt>や<tt>set
     xtics </tt>で図のミテクレを変えています．PNGの画像は，defaultでは
     640x480 pixelになりますが，これを縦横70%に縮小しています．最後の行
     で，plotするファイル名に標準入力 '-' を指定しています．これによって，
     中間ファイルを作ること無く，<tt>$count</tt>の内容をgnuplotに流し込
     むことが可能になります．</p>


<p>このスクリプトを走らせると，access_logを1ヵ月分集計したグラフができあ
     がります．毎日updateする程は無いでしょうから，週に1回程度このスクリ
     プトをcronで自動的に起動して，access.pngを更新するようにします．
     </p>

<div align="center"><img src="access_log.png" alt="access_log.png" width="448" height="336"></div>

<div class="top"><a href="access_plot.html#top"><img src="../image/mark-up.png" alt="up"></a></div>

</td></tr></table>
<hr class="topsep">

</body>
</html>
